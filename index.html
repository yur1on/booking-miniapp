<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ó–∞–ø–∏—Å—å</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg: #0b1220;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --border: rgba(255,255,255,.10);

      --ok: #27c26c;
      --ok2:#18a957;
      --bad:#ff4d4d;
      --accent:#6ee7ff;
      --accent2:#4f46e5;

      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --radius2: 14px;
    }

    /* Telegram theme support */
    body.tg {
      background: var(--tg-theme-bg-color, var(--bg));
      color: var(--tg-theme-text-color, var(--text));
    }

    * { box-sizing: border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color: var(--text);
    }

    .wrap{
      max-width: 820px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 26px;
    }

    .hero{
      border: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(79,70,229,.22), rgba(110,231,255,.12));
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      display:flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .hero .left{ min-width: 0; }
    .title{
      font-weight: 800;
      font-size: 18px;
      line-height: 1.2;
      margin: 0 0 4px 0;
    }
    .subtitle{
      margin:0;
      font-size: 13px;
      color: var(--muted);
    }
    .badge{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    .card{
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }

    .section-head{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .section-title{
      font-weight: 800;
      font-size: 14px;
      margin: 0;
      letter-spacing: .2px;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      margin: 0;
      text-align:right;
    }

    /* Services */
    .services{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 520px){
      .services{ grid-template-columns: 1fr; }
    }

    .svc{
      padding: 12px;
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      cursor: pointer;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
      user-select:none;
      min-height: 74px;
      display:flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 6px;
    }
    .svc:hover{ transform: translateY(-1px); border-color: rgba(110,231,255,.35); }
    .svc.active{
      border-color: rgba(110,231,255,.75);
      background: linear-gradient(135deg, rgba(110,231,255,.14), rgba(79,70,229,.14));
    }
    .svc-top{
      display:flex; justify-content: space-between; gap: 10px;
      align-items:flex-start;
    }
    .svc-name{
      font-weight: 800;
      font-size: 13px;
      line-height: 1.2;
      margin: 0;
    }
    .svc-price{
      font-weight: 900;
      font-size: 13px;
      margin:0;
      color: rgba(110,231,255,.92);
      white-space: nowrap;
    }
    .svc-meta{
      margin:0;
      font-size: 12px;
      color: var(--muted);
    }

    /* Date chips */
    .dates{
      display:flex;
      gap: 10px;
      overflow:auto;
      padding-bottom: 6px;
      scroll-snap-type: x mandatory;
    }
    .dates::-webkit-scrollbar{ height: 8px; }
    .dates::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.10); border-radius: 999px; }

    .date-chip{
      flex: 0 0 auto;
      width: 86px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      cursor: pointer;
      scroll-snap-align: start;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
      user-select:none;
      text-align:center;
    }
    .date-chip:hover{ transform: translateY(-1px); }
    .date-chip .d1{ font-weight: 900; font-size: 14px; margin:0; }
    .date-chip .d2{ font-size: 12px; margin: 2px 0 0 0; color: var(--muted); }

    .date-chip.ok{
      border-color: rgba(39,194,108,.35);
      background: linear-gradient(135deg, rgba(39,194,108,.12), rgba(110,231,255,.06));
    }
    .date-chip.bad{
      border-color: rgba(255,77,77,.28);
      background: rgba(255,77,77,.08);
      opacity: .75;
    }
    .date-chip.active{
      border-color: rgba(110,231,255,.80);
      background: linear-gradient(135deg, rgba(110,231,255,.16), rgba(79,70,229,.16));
    }

    /* Slots grid */
    .slots{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 520px){
      .slots{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }

    .slot{
      padding: 10px 8px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      cursor: pointer;
      text-align:center;
      font-weight: 900;
      font-size: 13px;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
      user-select:none;
    }
    .slot:hover{ transform: translateY(-1px); }
    .slot.ok{
      border-color: rgba(39,194,108,.35);
      background: linear-gradient(135deg, rgba(39,194,108,.10), rgba(110,231,255,.05));
    }
    .slot.active{
      border-color: rgba(39,194,108,.90);
      background: linear-gradient(135deg, rgba(39,194,108,.22), rgba(110,231,255,.12));
    }
    .slot.bad{
      border-color: rgba(255,77,77,.26);
      background: rgba(255,77,77,.06);
      opacity: .6;
    }

    .summary{
      display:flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-top: 10px;
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--card2);
    }
    .summary .line{
      margin:0;
      font-size: 13px;
      color: var(--muted);
    }
    .summary strong{ color: var(--text); }

    .small{
      margin: 8px 0 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
  </style>
</head>

<body class="tg">
  <div class="wrap">
    <div class="hero">
      <div class="left">
        <p class="title" id="hello">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>
        <p class="subtitle">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É, –¥–∞—Ç—É –∏ —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç –≤—Ä–µ–º–µ–Ω–∏</p>
      </div>
      <div class="badge" id="badge">Mini App</div>
    </div>

    <div class="grid">

      <!-- SERVICES -->
      <div class="card">
        <div class="section-head">
          <p class="section-title">–£—Å–ª—É–≥–∞</p>
          <p class="hint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É</p>
        </div>
        <div class="services" id="services"></div>
        <p class="small">–ü–æ–∑–∂–µ –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —É—Å–ª—É–≥ –∏–∑ Django API.</p>
      </div>

      <!-- DATES -->
      <div class="card">
        <div class="section-head">
          <p class="section-title">–î–∞—Ç–∞</p>
          <p class="hint">üü¢ –µ—Å—Ç—å —Å–ª–æ—Ç—ã ¬∑ üî¥ –∑–∞–∫—Ä—ã—Ç–æ</p>
        </div>
        <div class="dates" id="dates"></div>
        <p class="small">–°–µ–π—á–∞—Å ‚Äú—Å–≤–æ–±–æ–¥–Ω–æ—Å—Ç—å‚Äù —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (–±–µ–∑ —É—á—ë—Ç–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏). –ö–æ–≥–¥–∞ –ø–æ–¥–∫–ª—é—á–∏–º API ‚Äî –±—É–¥–µ—Ç 100% —Ç–æ—á–Ω–æ.</p>
      </div>

      <!-- SLOTS -->
      <div class="card">
        <div class="section-head">
          <p class="section-title">–í—Ä–µ–º—è</p>
          <p class="hint">–≤—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ—Ç</p>
        </div>
        <div class="slots" id="slots"></div>

        <div class="summary" id="summary" style="display:none;">
          <p class="line" id="summaryText"></p>
          <span class="pill" id="summaryPrice"></span>
        </div>

        <p class="small">
          –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ —Å–Ω–∏–∑—É –ø–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ Telegram ‚Äú–ó–∞–ø–∏—Å–∞—Ç—å—Å—è‚Äù.
        </p>
      </div>

    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
      document.body.classList.add("tg");
    }

    // ==========
    // CONFIG (–ø–æ–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ)
    // ==========
    const SERVICES = [
      { id: 1, name: "–ù–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∏–∫–∞", price: 40, durationMin: 120 },
      { id: 2, name: "2D/3D", price: 55, durationMin: 150 },
      { id: 3, name: "–ö–æ—Ä—Ä–µ–∫—Ü–∏—è", price: 30, durationMin: 90 },
      { id: 4, name: "–°–Ω—è—Ç–∏–µ", price: 15, durationMin: 30 },
    ];

    // –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è UI (–ø–æ–∫–∞ –±–µ–∑ API):
    // - —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏: 0..6 (0=–≤—Å)
    // - –∑–∞–∫—Ä—ã—Ç–æ: –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ (0) –Ω–∞–ø—Ä–∏–º–µ—Ä
    const CLOSED_WEEKDAYS = new Set([0]); // –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –∑–∞–∫—Ä—ã—Ç–æ
    const WORK_START = "09:00";
    const WORK_END   = "19:00";
    const STEP_MIN = 30;
    const DAYS_AHEAD = 14;

    // ==========
    // STATE
    // ==========
    let selectedService = null;
    let selectedDateISO = null; // YYYY-MM-DD
    let selectedTime = null;    // HH:MM

    // ==========
    // HELPERS
    // ==========
    function pad2(n){ return String(n).padStart(2, "0"); }

    function toISODate(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }

    function parseHM(hm){
      const [h,m] = hm.split(":").map(x => parseInt(x,10));
      return {h, m};
    }

    function minutesOf(hm){
      const {h,m} = parseHM(hm);
      return h*60 + m;
    }

    function hmFromMinutes(total){
      const h = Math.floor(total/60);
      const m = total % 60;
      return `${pad2(h)}:${pad2(m)}`;
    }

    function formatDateChip(iso){
      const d = new Date(iso + "T00:00:00");
      const dd = pad2(d.getDate());
      const mm = pad2(d.getMonth()+1);
      const wd = ["–í—Å","–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±"][d.getDay()];
      return { top: `${dd}.${mm}`, bottom: wd };
    }

    function nowLocal(){
      return new Date();
    }

    function isPastDate(iso){
      const today = new Date();
      const d = new Date(iso + "T00:00:00");
      // —Å—Ä–∞–≤–Ω–∏–º –ø–æ –¥–Ω—é
      const a = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
      const b = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
      return b < a;
    }

    function isClosed(iso){
      const d = new Date(iso + "T00:00:00");
      return CLOSED_WEEKDAYS.has(d.getDay());
    }

    // –¢—É—Ç ‚Äú–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å‚Äù –ø–æ–∫–∞ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é:
    // –µ—Å–ª–∏ –¥–µ–Ω—å –Ω–µ –∑–∞–∫—Ä—ã—Ç ‚Äî üü¢, –∏–Ω–∞—á–µ üî¥
    function hasSlotsOnDate(iso){
      if (isPastDate(iso)) return false;
      if (isClosed(iso)) return false;
      return true;
    }

    function buildSlotsForDate(iso){
      // –¢–æ–ª—å–∫–æ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é, –Ω–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
      if (!hasSlotsOnDate(iso)) return [];
      const start = minutesOf(WORK_START);
      const end = minutesOf(WORK_END);

      const slots = [];
      const now = nowLocal();
      const isToday = (toISODate(now) === iso);
      const nowMin = now.getHours()*60 + now.getMinutes();

      for (let t = start; t + STEP_MIN <= end; t += STEP_MIN){
        if (isToday && t < nowMin) continue; // –ø—Ä–æ—à–ª—ã–µ —Å–ª–æ—Ç—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è —Å–∫—Ä—ã–≤–∞–µ–º
        slots.push(hmFromMinutes(t));
      }
      return slots;
    }

    function updateMainButton(){
      const ok = !!(selectedService && selectedDateISO && selectedTime);
      if (!tg) return;

      if (!ok){
        tg.MainButton.hide();
        return;
      }
      tg.MainButton.setText("‚úÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è");
      tg.MainButton.show();
      tg.MainButton.enable();
    }

    function renderSummary(){
      const el = document.getElementById("summary");
      const txt = document.getElementById("summaryText");
      const price = document.getElementById("summaryPrice");

      if (!(selectedService && selectedDateISO && selectedTime)){
        el.style.display = "none";
        return;
      }

      const d = formatDateChip(selectedDateISO);
      txt.innerHTML = `–í—ã–±—Ä–∞–Ω–æ: <strong>${selectedService.name}</strong>, <strong>${d.top}</strong> (${d.bottom}), <strong>${selectedTime}</strong>`;
      price.textContent = `üí≥ ${selectedService.price} BYN`;
      el.style.display = "flex";
    }

    // ==========
    // RENDER SERVICES
    // ==========
    function renderServices(){
      const wrap = document.getElementById("services");
      wrap.innerHTML = "";

      SERVICES.forEach(s => {
        const div = document.createElement("div");
        div.className = "svc" + (selectedService?.id === s.id ? " active" : "");
        div.innerHTML = `
          <div class="svc-top">
            <p class="svc-name">${s.name}</p>
            <p class="svc-price">${s.price} BYN</p>
          </div>
          <p class="svc-meta">‚è± ${s.durationMin} –º–∏–Ω</p>
        `;
        div.onclick = () => {
          selectedService = s;
          // –ø—Ä–∏ —Å–º–µ–Ω–µ —É—Å–ª—É–≥–∏ –º–æ–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
          selectedTime = null;
          renderServices();
          renderSlots();
          renderSummary();
          updateMainButton();
        };
        wrap.appendChild(div);
      });
    }

    // ==========
    // RENDER DATES (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ, —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ)
    // ==========
    function renderDates(){
      const wrap = document.getElementById("dates");
      wrap.innerHTML = "";

      const today = new Date();
      for (let i=0; i<DAYS_AHEAD; i++){
        const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() + i);
        const iso = toISODate(d);

        const ok = hasSlotsOnDate(iso);
        const {top, bottom} = formatDateChip(iso);

        const chip = document.createElement("div");
        chip.className = "date-chip " + (ok ? "ok" : "bad") + (selectedDateISO === iso ? " active" : "");
        chip.innerHTML = `
          <p class="d1">${ok ? "üü¢" : "üî¥"} ${top}</p>
          <p class="d2">${bottom}</p>
        `;

        chip.onclick = () => {
          if (!ok) {
            if (tg?.showPopup) tg.showPopup({ title:"–ó–∞–∫—Ä—ã—Ç–æ", message:"–ù–∞ —ç—Ç—É –¥–∞—Ç—É –Ω–µ—Ç –∑–∞–ø–∏—Å–∏.", buttons:[{type:"ok"}] });
            return;
          }
          selectedDateISO = iso;
          selectedTime = null;
          renderDates();
          renderSlots();
          renderSummary();
          updateMainButton();
        };

        wrap.appendChild(chip);
      }

      // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–±–µ—Ä–µ–º —Å–µ–≥–æ–¥–Ω—è –µ—Å–ª–∏ –º–æ–∂–Ω–æ
      if (!selectedDateISO) {
        const todayISO = toISODate(new Date());
        if (hasSlotsOnDate(todayISO)) selectedDateISO = todayISO;
      }
    }

    // ==========
    // RENDER SLOTS (–∫–Ω–æ–ø–∫–∏ —Å–µ—Ç–∫–æ–π)
    // ==========
    function renderSlots(){
      const wrap = document.getElementById("slots");
      wrap.innerHTML = "";

      if (!selectedDateISO){
        wrap.innerHTML = `<div style="grid-column: 1 / -1; color: var(--muted); font-size: 13px;">
          –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã.
        </div>`;
        return;
      }

      const slots = buildSlotsForDate(selectedDateISO);
      if (!slots.length){
        wrap.innerHTML = `<div style="grid-column: 1 / -1; color: var(--muted); font-size: 13px;">
          –ù–∞ —ç—Ç—É –¥–∞—Ç—É –Ω–µ—Ç —Å–ª–æ—Ç–æ–≤.
        </div>`;
        return;
      }

      slots.forEach(hm => {
        const btn = document.createElement("div");
        const isActive = (selectedTime === hm);
        btn.className = "slot ok" + (isActive ? " active" : "");
        btn.textContent = hm;

        btn.onclick = () => {
          selectedTime = hm;
          renderSlots();
          renderSummary();
          updateMainButton();
        };

        wrap.appendChild(btn);
      });
    }

    // ==========
    // INIT
    // ==========
    function init(){
      const hello = document.getElementById("hello");
      const badge = document.getElementById("badge");

      if (tg){
        const u = tg.initDataUnsafe?.user;
        hello.textContent = u ? `–ü—Ä–∏–≤–µ—Ç, ${u.first_name}!` : "–ü—Ä–∏–≤–µ—Ç!";
        badge.textContent = "Telegram Mini App";
      } else {
        hello.textContent = "–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram";
        badge.textContent = "Web";
      }

      // default service
      selectedService = SERVICES[0];

      renderServices();
      renderDates();
      renderSlots();
      renderSummary();
      updateMainButton();

      if (tg){
        tg.MainButton.hide();

        tg.onEvent("mainButtonClicked", () => {
          if (!(selectedService && selectedDateISO && selectedTime)) return;

          const payload = {
            action: "book",
            service_id: selectedService.id,
            date: selectedDateISO,
            time: selectedTime
          };

          tg.sendData(JSON.stringify(payload));
          tg.close();
        });
      }
    }

    init();
  </script>
</body>
</html>
