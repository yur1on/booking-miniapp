<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ó–∞–ø–∏—Å—å</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* =========================
       Mobile-first + Telegram theme
       ========================= */
    :root{
      /* fallback colors (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç—å –Ω–µ –∏–∑ Telegram) */
      --bg: #0b1220;
      --text: rgba(255,255,255,.92);
      --hint: rgba(255,255,255,.62);
      --card: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.10);

      --ok: #22c55e;
      --bad:#ef4444;

      --radius: 16px;
      --radius2: 14px;

      --shadow: 0 10px 26px rgba(0,0,0,.25);

      /* —Ä–∞–∑–º–µ—Ä—ã */
      --tap: 44px;
      --gap: 12px;
      --pad: 16px;
    }

    /* Telegram theme variables */
    body{
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--tg-theme-bg-color, var(--bg));
      color: var(--tg-theme-text-color, var(--text));
    }

    .wrap{
      max-width: 860px;
      margin: 0 auto;
      padding:
        calc(var(--pad) + env(safe-area-inset-top))
        var(--pad)
        calc(var(--pad) + env(safe-area-inset-bottom));
    }

    .hero{
      border: 1px solid var(--tg-theme-hint-color, var(--border));
      background: linear-gradient(
        135deg,
        color-mix(in srgb, var(--tg-theme-button-color, #4f46e5) 22%, transparent),
        color-mix(in srgb, var(--tg-theme-link-color, #6ee7ff) 12%, transparent)
      );
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
    }

    .title{
      margin: 0;
      font-weight: 850;
      font-size: 18px;
      line-height: 1.2;
      letter-spacing: .2px;
    }

    .subtitle{
      margin: 6px 0 0 0;
      font-size: 13px;
      color: var(--tg-theme-hint-color, var(--hint));
      line-height: 1.35;
    }

    .pill{
      flex: 0 0 auto;
      border: 1px solid var(--tg-theme-hint-color, var(--border));
      background: color-mix(in srgb, var(--tg-theme-bg-color, #000) 80%, transparent);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      color: var(--tg-theme-hint-color, var(--hint));
      white-space: nowrap;
    }

    .grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--gap);
      margin-top: var(--gap);
    }

    .card{
      border: 1px solid var(--tg-theme-hint-color, var(--border));
      background: color-mix(in srgb, var(--tg-theme-bg-color, var(--bg)) 82%, white 18%);
      /* –≤—ã—à–µ ‚Äî –º—è–≥–∫–∏–π ‚Äú—Å—Ç–µ–∫–ª—è–Ω–Ω—ã–π‚Äù —ç—Ñ—Ñ–µ–∫—Ç –¥–∞–∂–µ –≤ —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º–µ */
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }

    .head{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .h{
      margin: 0;
      font-weight: 850;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .hint{
      margin: 0;
      font-size: 12px;
      color: var(--tg-theme-hint-color, var(--hint));
      text-align: right;
      line-height: 1.2;
    }

    /* =========================
       SERVICES (–∫–∞—Ä—Ç–æ—á–∫–∏, —Å–∏–º–º–µ—Ç—Ä–∏—è)
       ========================= */
    .services{
      display:grid;
      gap: 10px;
      grid-template-columns: repeat(2, minmax(0,1fr));
    }
    @media (max-width: 520px){
      .services{ grid-template-columns: 1fr; }
    }

    .svc{
      min-height: 76px;
      border-radius: var(--radius2);
      border: 1px solid var(--tg-theme-hint-color, var(--border));
      background: color-mix(in srgb, var(--tg-theme-bg-color, var(--bg)) 88%, white 12%);
      padding: 12px;
      cursor: pointer;
      user-select:none;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
      display:flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 8px;
    }
    .svc:active{ transform: scale(.99); }

    .svc.active{
      border-color: color-mix(in srgb, var(--tg-theme-button-color, #4f46e5) 70%, white 30%);
      background: linear-gradient(
        135deg,
        color-mix(in srgb, var(--tg-theme-button-color, #4f46e5) 18%, transparent),
        color-mix(in srgb, var(--tg-theme-link-color, #6ee7ff) 10%, transparent)
      );
    }

    .svc-top{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content: space-between;
    }
    .svc-name{
      margin: 0;
      font-weight: 850;
      font-size: 13px;
      line-height: 1.2;
    }
    .svc-price{
      margin: 0;
      font-weight: 900;
      font-size: 13px;
      color: var(--tg-theme-link-color, #6ee7ff);
      white-space: nowrap;
    }
    .svc-meta{
      margin: 0;
      font-size: 12px;
      color: var(--tg-theme-hint-color, var(--hint));
    }

    /* =========================
       DATES (—á–∏–ø—ã, –∞–∫–∫—É—Ä–∞—Ç–Ω–æ, —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ)
       ========================= */
    .dates{
      display:flex;
      gap: 10px;
      overflow:auto;
      padding-bottom: 6px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .dates::-webkit-scrollbar{ height: 8px; }
    .dates::-webkit-scrollbar-thumb{
      background: color-mix(in srgb, var(--tg-theme-hint-color, #999) 25%, transparent);
      border-radius: 999px;
    }

    .date{
      width: 92px;
      flex: 0 0 auto;
      scroll-snap-align: start;
      border-radius: 14px;
      border: 1px solid var(--tg-theme-hint-color, var(--border));
      background: color-mix(in srgb, var(--tg-theme-bg-color, var(--bg)) 88%, white 12%);
      padding: 10px 10px;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
      text-align:center;
      min-height: var(--tap);
      display:flex;
      flex-direction: column;
      justify-content: center;
      gap: 2px;
    }
    .date:active{ transform: scale(.99); }

    .date.ok{
      border-color: color-mix(in srgb, var(--ok) 35%, white 65%);
      background: linear-gradient(
        135deg,
        color-mix(in srgb, var(--ok) 14%, transparent),
        color-mix(in srgb, var(--tg-theme-link-color, #6ee7ff) 7%, transparent)
      );
    }
    .date.bad{
      border-color: color-mix(in srgb, var(--bad) 30%, white 70%);
      background: color-mix(in srgb, var(--bad) 10%, transparent);
      opacity: .78;
    }
    .date.active{
      border-color: color-mix(in srgb, var(--tg-theme-button-color, #4f46e5) 70%, white 30%);
      background: linear-gradient(
        135deg,
        color-mix(in srgb, var(--tg-theme-button-color, #4f46e5) 16%, transparent),
        color-mix(in srgb, var(--tg-theme-link-color, #6ee7ff) 10%, transparent)
      );
    }

    .d1{
      margin:0;
      font-weight: 950;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .d2{
      margin:0;
      font-size: 12px;
      color: var(--tg-theme-hint-color, var(--hint));
    }

    /* =========================
       SLOTS (–ø–ª–∏—Ç–∫–∏, –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞)
       ========================= */
    .slots{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
    }
    /* –±–æ–ª–µ–µ —à–∏—Ä–æ–∫–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã / –º–∞–ª–µ–Ω—å–∫–∏–µ –ø–ª–∞–Ω—à–µ—Ç—ã */
    @media (min-width: 420px){
      .slots{ grid-template-columns: repeat(4, minmax(0,1fr)); }
    }
    @media (min-width: 720px){
      .slots{ grid-template-columns: repeat(6, minmax(0,1fr)); }
    }

    .slot{
      height: var(--tap);
      border-radius: 14px;
      border: 1px solid var(--tg-theme-hint-color, var(--border));
      background: color-mix(in srgb, var(--tg-theme-bg-color, var(--bg)) 88%, white 12%);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      font-size: 13px;
      letter-spacing: .2px;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
    }
    .slot:active{ transform: scale(.99); }

    .slot.ok{
      border-color: color-mix(in srgb, var(--ok) 35%, white 65%);
      background: linear-gradient(
        135deg,
        color-mix(in srgb, var(--ok) 12%, transparent),
        color-mix(in srgb, var(--tg-theme-link-color, #6ee7ff) 6%, transparent)
      );
    }
    .slot.active{
      border-color: color-mix(in srgb, var(--ok) 75%, white 25%);
      background: linear-gradient(
        135deg,
        color-mix(in srgb, var(--ok) 22%, transparent),
        color-mix(in srgb, var(--tg-theme-link-color, #6ee7ff) 12%, transparent)
      );
    }

    .empty{
      grid-column: 1 / -1;
      padding: 8px 2px 2px;
      color: var(--tg-theme-hint-color, var(--hint));
      font-size: 13px;
      line-height: 1.35;
    }

    .summary{
      margin-top: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--tg-theme-hint-color, var(--border));
      background: color-mix(in srgb, var(--tg-theme-bg-color, var(--bg)) 86%, white 14%);
      padding: 12px;
      display:none;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .summary p{
      margin: 0;
      font-size: 13px;
      color: var(--tg-theme-hint-color, var(--hint));
      line-height: 1.35;
    }
    .summary strong{ color: var(--tg-theme-text-color, var(--text)); }
    .summary .price{
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      border: 1px solid var(--tg-theme-hint-color, var(--border));
      background: color-mix(in srgb, var(--tg-theme-bg-color, var(--bg)) 88%, white 12%);
      color: var(--tg-theme-text-color, var(--text));
      white-space: nowrap;
    }

    .note{
      margin: 10px 0 0 0;
      font-size: 12px;
      color: var(--tg-theme-hint-color, var(--hint));
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <div>
        <p class="title" id="hello">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>
        <p class="subtitle">1) –£—Å–ª—É–≥–∞ ‚Üí 2) –î–∞—Ç–∞ ‚Üí 3) –í—Ä–µ–º—è. –ó–∞–ø–∏—Å—å –æ—Ñ–æ—Ä–º–∏—Ç—Å—è –∫–Ω–æ–ø–∫–æ–π Telegram —Å–Ω–∏–∑—É.</p>
      </div>
      <div class="pill" id="badge">Mini App</div>
    </div>

    <div class="grid">

      <!-- SERVICES -->
      <div class="card">
        <div class="head">
          <p class="h">–£—Å–ª—É–≥–∞</p>
          <p class="hint">–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É</p>
        </div>
        <div class="services" id="services"></div>
      </div>

      <!-- DATES -->
      <div class="card">
        <div class="head">
          <p class="h">–î–∞—Ç–∞</p>
          <p class="hint">üü¢ —Å–≤–æ–±–æ–¥–Ω–æ ¬∑ üî¥ –∑–∞–∫—Ä—ã—Ç–æ</p>
        </div>
        <div class="dates" id="dates"></div>
        <p class="note">
          –°–µ–π—á–∞—Å ‚Äú—Å–≤–æ–±–æ–¥–Ω–æ‚Äù ‚Äî –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (–±–µ–∑ —É—á—ë—Ç–∞ –∑–∞–Ω—è—Ç—ã—Ö –∑–∞–ø–∏—Å–µ–π).
          –ö–æ–≥–¥–∞ –ø–æ–¥–∫–ª—é—á–∏–º API, –±—É–¥—É—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ —Å–≤–æ–±–æ–¥–Ω—ã–µ –¥–∞—Ç—ã/—Å–ª–æ—Ç—ã.
        </p>
      </div>

      <!-- SLOTS -->
      <div class="card">
        <div class="head">
          <p class="h">–í—Ä–µ–º—è</p>
          <p class="hint">–°–ª–æ—Ç—ã</p>
        </div>
        <div class="slots" id="slots"></div>

        <div class="summary" id="summary">
          <p id="summaryText"></p>
          <span class="price" id="summaryPrice"></span>
        </div>

        <p class="note">–°–æ–≤–µ—Ç: –µ—Å–ª–∏ –Ω–µ –≤–∏–¥–∏—Ç–µ –Ω—É–∂–Ω—É—é –¥–∞—Ç—É ‚Äî –ª–∏—Å—Ç–∞–π—Ç–µ —á–∏–ø—ã –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ.</p>
      </div>

    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
    }

    // =====================
    // –í–†–ï–ú–ï–ù–ù–´–ï –î–ê–ù–ù–´–ï (–ø–æ–∑–∂–µ –∑–∞–º–µ–Ω–∏–º –Ω–∞ API)
    // =====================
    const SERVICES = [
      { id: 1, name: "–ù–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∏–∫–∞", price: 40, durationMin: 120 },
      { id: 2, name: "2D/3D", price: 55, durationMin: 150 },
      { id: 3, name: "–ö–æ—Ä—Ä–µ–∫—Ü–∏—è", price: 30, durationMin: 90 },
      { id: 4, name: "–°–Ω—è—Ç–∏–µ", price: 15, durationMin: 30 },
    ];

    const CLOSED_WEEKDAYS = new Set([0]); // 0=–í—Å –∑–∞–∫—Ä—ã—Ç–æ
    const WORK_START = "09:00";
    const WORK_END   = "19:00";
    const STEP_MIN = 30;
    const DAYS_AHEAD = 14;

    // =====================
    // STATE
    // =====================
    let selectedService = null;
    let selectedDateISO = null; // YYYY-MM-DD
    let selectedTime = null;    // HH:MM

    // =====================
    // helpers
    // =====================
    function pad2(n){ return String(n).padStart(2, "0"); }
    function toISODate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
    function parseHM(hm){ const [h,m] = hm.split(":").map(x => parseInt(x,10)); return {h,m}; }
    function minutesOf(hm){ const {h,m} = parseHM(hm); return h*60 + m; }
    function hmFromMinutes(total){
      const h = Math.floor(total/60);
      const m = total % 60;
      return `${pad2(h)}:${pad2(m)}`;
    }

    function formatDateChip(iso){
      const d = new Date(iso + "T00:00:00");
      const dd = pad2(d.getDate());
      const mm = pad2(d.getMonth()+1);
      const wd = ["–í—Å","–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±"][d.getDay()];
      return { top: `${dd}.${mm}`, bottom: wd };
    }

    function isPastDate(iso){
      const today = new Date();
      const d = new Date(iso + "T00:00:00");
      const a = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
      const b = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
      return b < a;
    }

    function isClosed(iso){
      const d = new Date(iso + "T00:00:00");
      return CLOSED_WEEKDAYS.has(d.getDay());
    }

    // –ü–æ–∫–∞ "—Å–≤–æ–±–æ–¥–Ω–æ" = –¥–µ–Ω—å –Ω–µ –∑–∞–∫—Ä—ã—Ç –∏ –Ω–µ –≤ –ø—Ä–æ—à–ª–æ–º
    function hasSlotsOnDate(iso){
      if (isPastDate(iso)) return false;
      if (isClosed(iso)) return false;
      return true;
    }

    function buildSlotsForDate(iso){
      if (!hasSlotsOnDate(iso)) return [];
      const start = minutesOf(WORK_START);
      const end   = minutesOf(WORK_END);
      const slots = [];

      const now = new Date();
      const isToday = (toISODate(now) === iso);
      const nowMin = now.getHours()*60 + now.getMinutes();

      for (let t = start; t + STEP_MIN <= end; t += STEP_MIN){
        if (isToday && t < nowMin) continue;
        slots.push(hmFromMinutes(t));
      }
      return slots;
    }

    function updateMainButton(){
      if (!tg) return;
      const ok = !!(selectedService && selectedDateISO && selectedTime);
      if (!ok){
        tg.MainButton.hide();
        return;
      }
      tg.MainButton.setText("‚úÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è");
      tg.MainButton.show();
      tg.MainButton.enable();
    }

    function renderSummary(){
      const el = document.getElementById("summary");
      const txt = document.getElementById("summaryText");
      const price = document.getElementById("summaryPrice");

      if (!(selectedService && selectedDateISO && selectedTime)){
        el.style.display = "none";
        return;
      }
      const d = formatDateChip(selectedDateISO);
      txt.innerHTML = `–í—ã –≤—ã–±—Ä–∞–ª–∏: <strong>${selectedService.name}</strong>, <strong>${d.top}</strong> (${d.bottom}), <strong>${selectedTime}</strong>`;
      price.textContent = `üí≥ ${selectedService.price} BYN`;
      el.style.display = "flex";
    }

    // =====================
    // render services
    // =====================
    function renderServices(){
      const wrap = document.getElementById("services");
      wrap.innerHTML = "";

      SERVICES.forEach(s => {
        const div = document.createElement("div");
        div.className = "svc" + (selectedService?.id === s.id ? " active" : "");
        div.innerHTML = `
          <div class="svc-top">
            <p class="svc-name">${s.name}</p>
            <p class="svc-price">${s.price} BYN</p>
          </div>
          <p class="svc-meta">‚è± ${s.durationMin} –º–∏–Ω</p>
        `;
        div.onclick = () => {
          selectedService = s;
          selectedTime = null;
          renderServices();
          renderSlots();
          renderSummary();
          updateMainButton();
        };
        wrap.appendChild(div);
      });
    }

    // =====================
    // render dates
    // =====================
    function renderDates(){
      const wrap = document.getElementById("dates");
      wrap.innerHTML = "";

      const today = new Date();
      for (let i=0; i<DAYS_AHEAD; i++){
        const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() + i);
        const iso = toISODate(d);

        const ok = hasSlotsOnDate(iso);
        const {top, bottom} = formatDateChip(iso);

        const chip = document.createElement("div");
        chip.className = "date " + (ok ? "ok" : "bad") + (selectedDateISO === iso ? " active" : "");
        chip.innerHTML = `
          <p class="d1">${ok ? "üü¢" : "üî¥"} ${top}</p>
          <p class="d2">${bottom}</p>
        `;

        chip.onclick = () => {
          if (!ok){
            tg?.showPopup?.({ title: "–ó–∞–∫—Ä—ã—Ç–æ", message: "–ù–∞ —ç—Ç—É –¥–∞—Ç—É –∑–∞–ø–∏—Å—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.", buttons: [{type:"ok"}] });
            return;
          }
          selectedDateISO = iso;
          selectedTime = null;
          renderDates();
          renderSlots();
          renderSummary();
          updateMainButton();
        };

        wrap.appendChild(chip);
      }

      if (!selectedDateISO) {
        const todayISO = toISODate(new Date());
        if (hasSlotsOnDate(todayISO)) selectedDateISO = todayISO;
      }
    }

    // =====================
    // render slots
    // =====================
    function renderSlots(){
      const wrap = document.getElementById("slots");
      wrap.innerHTML = "";

      if (!selectedDateISO){
        wrap.innerHTML = `<div class="empty">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ª–æ—Ç—ã.</div>`;
        return;
      }

      const slots = buildSlotsForDate(selectedDateISO);
      if (!slots.length){
        wrap.innerHTML = `<div class="empty">–ù–∞ —ç—Ç—É –¥–∞—Ç—É –Ω–µ—Ç —Å–ª–æ—Ç–æ–≤.</div>`;
        return;
      }

      slots.forEach(hm => {
        const btn = document.createElement("div");
        const active = (selectedTime === hm);
        btn.className = "slot ok" + (active ? " active" : "");
        btn.textContent = hm;

        btn.onclick = () => {
          selectedTime = hm;
          renderSlots();
          renderSummary();
          updateMainButton();
        };

        wrap.appendChild(btn);
      });
    }

    // =====================
    // init
    // =====================
    function init(){
      const hello = document.getElementById("hello");
      const badge = document.getElementById("badge");

      if (tg){
        const u = tg.initDataUnsafe?.user;
        hello.textContent = u ? `–ü—Ä–∏–≤–µ—Ç, ${u.first_name}!` : "–ü—Ä–∏–≤–µ—Ç!";
        badge.textContent = "Telegram Mini App";
        tg.MainButton.hide();

        tg.onEvent("mainButtonClicked", () => {
          if (!(selectedService && selectedDateISO && selectedTime)) return;
          const payload = {
            action: "book",
            service_id: selectedService.id,
            date: selectedDateISO,
            time: selectedTime
          };
          tg.sendData(JSON.stringify(payload));
          tg.close();
        });
      } else {
        hello.textContent = "–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram";
        badge.textContent = "Web";
      }

      selectedService = SERVICES[0];
      renderServices();
      renderDates();
      renderSlots();
      renderSummary();
      updateMainButton();
    }

    init();
  </script>
</body>
</html>
