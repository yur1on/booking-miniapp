<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Запись</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 16px; }
    .card { padding: 14px; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 12px; }
    label { display:block; margin: 10px 0 6px; font-weight: 600; }
    select, input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; }
    button { width: 100%; padding: 12px; border-radius: 12px; border: 0; font-weight: 700; }
    .muted { color: #666; font-size: 13px; }
  </style>
</head>
<body>
  <div class="card">
    <div id="hello" style="font-weight:700; font-size:18px;">Загрузка…</div>
    <div class="muted">Mini App внутри Telegram</div>
  </div>

  <div class="card">
    <label>Услуга</label>
    <select id="service">
      <!-- Временно статикой. Потом можно грузить с Django API -->
      <option value="1" data-price="40">Наращивание классика — 40 BYN</option>
      <option value="2" data-price="55">2D/3D — 55 BYN</option>
      <option value="3" data-price="30">Коррекция — 30 BYN</option>
    </select>

    <label>Дата</label>
    <input id="date" type="date" />

    <label>Время</label>
    <input id="time" type="time" step="1800" />

    <div style="height:10px"></div>
    <button id="send">✅ Отправить заявку в бот</button>
    <div class="muted" style="margin-top:10px;">
      После отправки бот подтвердит запись.
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (!tg) {
      document.getElementById('hello').textContent = "Откройте через Telegram";
    } else {
      tg.ready();
      tg.expand();

      const user = tg.initDataUnsafe?.user;
      document.getElementById('hello').textContent =
        user ? `Привет, ${user.first_name}!` : "Привет!";

      // Поставим дату сегодня по локальному времени
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;

      document.getElementById('send').onclick = () => {
        const sel = document.getElementById('service');
        const service_id = parseInt(sel.value, 10);
        const service_price = sel.options[sel.selectedIndex].dataset.price;

        const dateVal = document.getElementById('date').value;   // YYYY-MM-DD
        const timeVal = document.getElementById('time').value;   // HH:MM

        if (!dateVal || !timeVal) {
          tg.showPopup?.({ title: "Ошибка", message: "Выберите дату и время", buttons: [{type:"ok"}] });
          return;
        }

        const payload = {
          action: "book",
          service_id,
          date: dateVal,
          time: timeVal,
          price: service_price
        };

        tg.sendData(JSON.stringify(payload));
        tg.close();
      };
    }
  </script>
</body>
</html>
